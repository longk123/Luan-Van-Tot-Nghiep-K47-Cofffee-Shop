import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { api } from '../api.js';

export default function ManagerDashboard() {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);
  const [kpis, setKpis] = useState(null);
  const [revenueChart, setRevenueChart] = useState(null);
  const [invoices, setInvoices] = useState([]);
  const [activeTab, setActiveTab] = useState('overview');

  const loadData = async () => {
    try {
      setLoading(true);
      
      // Check if user is still logged in
      const token = localStorage.getItem('token');
      if (!token) {
        console.log('âŒ No token found, redirecting to login');
        navigate('/login');
        return;
      }
      
      console.log('ğŸ” Loading data...');
      
      // Load KPI data
      const kpiResponse = await api.getOverviewKPIs();
      console.log('âœ… KPI data loaded:', kpiResponse);
      setKpis(kpiResponse.data);
      
      // Load Revenue Chart
      const revenueResponse = await api.getRevenueChart(7);
      console.log('âœ… Revenue data loaded:', revenueResponse);
      setRevenueChart(revenueResponse.data);
      
      // Load Invoices
      const invoicesResponse = await api.getAllInvoices({ limit: 10 });
      console.log('âœ… Invoices data loaded:', invoicesResponse);
      setInvoices(invoicesResponse.data?.invoices || []);
      
    } catch (error) {
      console.error('âŒ Error loading data:', error);
      
      // If 401 error, redirect to login
      if (error.response?.status === 401 || error.message?.includes('401')) {
        console.log('âŒ Unauthorized, redirecting to login');
        localStorage.removeItem('token');
        navigate('/login');
        return;
      }
      
      // Show error message
      alert('KhÃ´ng thá»ƒ táº£i dá»¯ liá»‡u. Vui lÃ²ng thá»­ láº¡i sau.');
      
    } finally {
      setLoading(false);
    }
  };

  return (
    <div style={{ padding: '20px', backgroundColor: '#f0f0f0', minHeight: '100vh' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
        <div>
          <h1 style={{ fontSize: '2rem', fontWeight: 'bold', margin: 0 }}>Manager Dashboard</h1>
          <p style={{ color: '#666', margin: '5px 0 0 0' }}>Tá»•ng quan vÃ  phÃ¢n tÃ­ch hiá»‡u suáº¥t quÃ¡n</p>
        </div>
        <div style={{ display: 'flex', gap: '10px' }}>
          <button 
            onClick={() => navigate('/dashboard')}
            style={{ padding: '10px 15px', backgroundColor: '#6b7280', color: 'white', border: 'none', borderRadius: '5px' }}
          >
            ğŸ  Dashboard
          </button>
          <button 
            onClick={() => window.location.reload()}
            style={{ padding: '10px 15px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '5px' }}
          >
            ğŸ”„ LÃ m má»›i
          </button>
        </div>
      </div>

      {/* Navigation Tabs */}
      <div style={{ borderBottom: '1px solid #e5e7eb', marginBottom: '20px' }}>
        <div style={{ display: 'flex', gap: '20px' }}>
          {[
            { id: 'overview', name: 'ğŸ“Š Tá»•ng quan', icon: 'ğŸ“Š' },
            { id: 'revenue', name: 'ğŸ’° Doanh thu', icon: 'ğŸ’°' },
            { id: 'invoices', name: 'ğŸ“„ HÃ³a Ä‘Æ¡n', icon: 'ğŸ“„' }
          ].map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              style={{
                padding: '10px 15px',
                borderBottom: activeTab === tab.id ? '2px solid #3b82f6' : '2px solid transparent',
                backgroundColor: 'transparent',
                border: 'none',
                color: activeTab === tab.id ? '#3b82f6' : '#6b7280',
                cursor: 'pointer',
                fontSize: '14px',
                fontWeight: '500'
              }}
            >
              {tab.name}
            </button>
          ))}
        </div>
      </div>

      {/* Tab Content */}
      {activeTab === 'overview' && (
        <div>
          {/* KPI Cards */}
      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(250px, 1fr))', gap: '20px', marginBottom: '20px' }}>
        <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h3 style={{ margin: '0 0 10px 0', color: '#059669' }}>ğŸ’° Doanh thu hÃ´m nay</h3>
          <p style={{ fontSize: '1.5rem', fontWeight: 'bold', margin: 0 }}>
            {kpis ? `${kpis.today_revenue?.toLocaleString('vi-VN')} VNÄ` : '1,250,000 VNÄ'}
          </p>
          <p style={{ color: '#666', margin: '5px 0 0 0', fontSize: '0.9rem' }}>
            {kpis ? `${kpis.revenue_change > 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${Math.abs(kpis.revenue_change)}% so vá»›i hÃ´m qua` : 'â†—ï¸ 15% so vá»›i hÃ´m qua'}
          </p>
        </div>
        
        <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h3 style={{ margin: '0 0 10px 0', color: '#3b82f6' }}>ğŸ›’ ÄÆ¡n hÃ ng Ä‘Ã£ thanh toÃ¡n</h3>
          <p style={{ fontSize: '1.5rem', fontWeight: 'bold', margin: 0 }}>
            {kpis ? kpis.paid_orders : '45'}
          </p>
          <p style={{ color: '#666', margin: '5px 0 0 0', fontSize: '0.9rem' }}>
            {kpis ? `${kpis.orders_change > 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${Math.abs(kpis.orders_change)}% so vá»›i hÃ´m qua` : 'â†—ï¸ 8% so vá»›i hÃ´m qua'}
          </p>
        </div>
        
        <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h3 style={{ margin: '0 0 10px 0', color: '#f59e0b' }}>ğŸª‘ BÃ n Ä‘ang phá»¥c vá»¥</h3>
          <p style={{ fontSize: '1.5rem', fontWeight: 'bold', margin: 0 }}>
            {kpis ? `${kpis.active_tables} / ${kpis.total_tables}` : '8 / 20'}
          </p>
          <p style={{ color: '#666', margin: '5px 0 0 0', fontSize: '0.9rem' }}>
            {kpis ? `${Math.round((kpis.active_tables / kpis.total_tables) * 100)}% sá»­ dá»¥ng` : '40% sá»­ dá»¥ng'}
          </p>
        </div>
        
        <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h3 style={{ margin: '0 0 10px 0', color: '#dc2626' }}>ğŸ³ MÃ³n chá» báº¿p</h3>
          <p style={{ fontSize: '1.5rem', fontWeight: 'bold', margin: 0 }}>
            {kpis ? kpis.pending_items : '12'}
          </p>
          <p style={{ color: '#666', margin: '5px 0 0 0', fontSize: '0.9rem' }}>
            Äang chá» xá»­ lÃ½
          </p>
        </div>
      </div>
      
          {/* Load Data Button */}
          <div style={{ textAlign: 'center', marginBottom: '20px' }}>
            <button 
              onClick={loadData}
              disabled={loading}
              style={{ 
                padding: '10px 20px', 
                backgroundColor: loading ? '#9ca3af' : '#10b981', 
                color: 'white', 
                border: 'none', 
                borderRadius: '5px',
                cursor: loading ? 'not-allowed' : 'pointer'
              }}
            >
              {loading ? 'Äang táº£i...' : 'ğŸ“Š Táº£i dá»¯ liá»‡u thá»±c'}
            </button>
          </div>
        </div>
      )}

      {activeTab === 'revenue' && (
        <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h3 style={{ margin: '0 0 20px 0', color: '#1f2937' }}>ğŸ“ˆ Biá»ƒu Ä‘á»“ doanh thu 7 ngÃ y gáº§n nháº¥t</h3>
          {revenueChart ? (
            <div>
              <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '15px', marginBottom: '20px' }}>
                <div style={{ textAlign: 'center', padding: '15px', backgroundColor: '#f3f4f6', borderRadius: '8px' }}>
                  <p style={{ margin: '0 0 5px 0', color: '#6b7280', fontSize: '14px' }}>Tá»•ng doanh thu</p>
                  <p style={{ margin: 0, fontSize: '1.2rem', fontWeight: 'bold', color: '#059669' }}>
                    {revenueChart.total_revenue?.toLocaleString('vi-VN')} VNÄ
                  </p>
                </div>
                <div style={{ textAlign: 'center', padding: '15px', backgroundColor: '#f3f4f6', borderRadius: '8px' }}>
                  <p style={{ margin: '0 0 5px 0', color: '#6b7280', fontSize: '14px' }}>Táº¡i bÃ n</p>
                  <p style={{ margin: 0, fontSize: '1.2rem', fontWeight: 'bold', color: '#3b82f6' }}>
                    {revenueChart.dine_in_revenue?.toLocaleString('vi-VN')} VNÄ
                  </p>
                </div>
                <div style={{ textAlign: 'center', padding: '15px', backgroundColor: '#f3f4f6', borderRadius: '8px' }}>
                  <p style={{ margin: '0 0 5px 0', color: '#6b7280', fontSize: '14px' }}>Mang Ä‘i</p>
                  <p style={{ margin: 0, fontSize: '1.2rem', fontWeight: 'bold', color: '#f59e0b' }}>
                    {revenueChart.takeaway_revenue?.toLocaleString('vi-VN')} VNÄ
                  </p>
                </div>
              </div>
              <div style={{ textAlign: 'center', padding: '40px', backgroundColor: '#f9fafb', borderRadius: '8px' }}>
                <p style={{ color: '#6b7280' }}>ğŸ“Š Biá»ƒu Ä‘á»“ sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ á»Ÿ Ä‘Ã¢y</p>
                <p style={{ color: '#9ca3af', fontSize: '14px' }}>Dá»¯ liá»‡u: {revenueChart.days?.length || 0} ngÃ y</p>
              </div>
            </div>
          ) : (
            <div style={{ textAlign: 'center', padding: '40px' }}>
              <p style={{ color: '#6b7280' }}>ChÆ°a cÃ³ dá»¯ liá»‡u doanh thu</p>
              <button 
                onClick={loadData}
                style={{ 
                  padding: '8px 16px', 
                  backgroundColor: '#3b82f6', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '5px',
                  cursor: 'pointer'
                }}
              >
                Táº£i dá»¯ liá»‡u
              </button>
            </div>
          )}
        </div>
      )}

      {activeTab === 'invoices' && (
        <div style={{ backgroundColor: 'white', padding: '20px', borderRadius: '10px', boxShadow: '0 2px 4px rgba(0,0,0,0.1)' }}>
          <h3 style={{ margin: '0 0 20px 0', color: '#1f2937' }}>ğŸ“„ Danh sÃ¡ch hÃ³a Ä‘Æ¡n gáº§n nháº¥t</h3>
          {invoices.length > 0 ? (
            <div style={{ overflowX: 'auto' }}>
              <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                <thead>
                  <tr style={{ backgroundColor: '#f9fafb' }}>
                    <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #e5e7eb', fontSize: '14px', fontWeight: '600' }}>ID</th>
                    <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #e5e7eb', fontSize: '14px', fontWeight: '600' }}>BÃ n</th>
                    <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #e5e7eb', fontSize: '14px', fontWeight: '600' }}>Tá»•ng tiá»n</th>
                    <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #e5e7eb', fontSize: '14px', fontWeight: '600' }}>Tráº¡ng thÃ¡i</th>
                    <th style={{ padding: '12px', textAlign: 'left', borderBottom: '1px solid #e5e7eb', fontSize: '14px', fontWeight: '600' }}>Thá»i gian</th>
                  </tr>
                </thead>
                <tbody>
                  {invoices.slice(0, 10).map((invoice) => (
                    <tr key={invoice.id} style={{ borderBottom: '1px solid #f3f4f6' }}>
                      <td style={{ padding: '12px', fontSize: '14px' }}>#{invoice.id}</td>
                      <td style={{ padding: '12px', fontSize: '14px' }}>
                        {invoice.table_name || 'Mang Ä‘i'}
                      </td>
                      <td style={{ padding: '12px', fontSize: '14px', fontWeight: '600', color: '#059669' }}>
                        {invoice.total_amount?.toLocaleString('vi-VN')} VNÄ
                      </td>
                      <td style={{ padding: '12px', fontSize: '14px' }}>
                        <span style={{
                          padding: '4px 8px',
                          borderRadius: '4px',
                          fontSize: '12px',
                          fontWeight: '500',
                          backgroundColor: invoice.status === 'PAID' ? '#dcfce7' : '#fef3c7',
                          color: invoice.status === 'PAID' ? '#166534' : '#92400e'
                        }}>
                          {invoice.status === 'PAID' ? 'âœ… ÄÃ£ thanh toÃ¡n' : 'â³ Chá» thanh toÃ¡n'}
                        </span>
                      </td>
                      <td style={{ padding: '12px', fontSize: '14px', color: '#6b7280' }}>
                        {new Date(invoice.created_at).toLocaleString('vi-VN')}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            <div style={{ textAlign: 'center', padding: '40px' }}>
              <p style={{ color: '#6b7280' }}>ChÆ°a cÃ³ dá»¯ liá»‡u hÃ³a Ä‘Æ¡n</p>
              <button 
                onClick={loadData}
                style={{ 
                  padding: '8px 16px', 
                  backgroundColor: '#3b82f6', 
                  color: 'white', 
                  border: 'none', 
                  borderRadius: '5px',
                  cursor: 'pointer'
                }}
              >
                Táº£i dá»¯ liá»‡u
              </button>
            </div>
          )}
        </div>
      )}

      {/* Navigation buttons */}
      <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
        <button 
          onClick={() => navigate('/dashboard')}
          style={{ padding: '10px 20px', backgroundColor: '#3b82f6', color: 'white', border: 'none', borderRadius: '5px' }}
        >
          ğŸ’° Äi tá»›i trang Thu ngÃ¢n
        </button>
        <button 
          onClick={() => navigate('/kitchen')}
          style={{ padding: '10px 20px', backgroundColor: '#059669', color: 'white', border: 'none', borderRadius: '5px' }}
        >
          ğŸ³ Äi tá»›i trang Báº¿p
        </button>
      </div>
    </div>
  );
}